{% extends "base.html" %}

{% block title %}{{ course.title }} - CogniStream AI{% endblock %}

{% block content %}
<div class="py-12 bg-slate-50 min-h-screen">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Course Header -->
        <div class="relative bg-slate-900 rounded-[3rem] p-10 md:p-16 overflow-hidden mb-12 shadow-2xl">
            <div class="absolute top-0 right-0 w-1/2 h-full bg-indigo-500/20 blur-[100px]"></div>

            <div class="relative z-10 flex flex-col md:flex-row items-center justify-between gap-12">
                <div class="space-y-6 max-w-2xl">
                    <div
                        class="inline-flex items-center space-x-2 bg-indigo-600/30 text-indigo-400 px-4 py-2 rounded-full font-bold text-sm uppercase tracking-widest border border-indigo-500/30">
                        <i class="fas fa-certificate"></i>
                        <span>Verified Course</span>
                    </div>
                    <h1 class="text-4xl md:text-6xl font-extrabold text-white leading-tight">{{ course.title }}</h1>
                    <p class="text-xl text-slate-400 leading-relaxed">{{ course.description }}</p>
                    <div class="flex flex-wrap gap-6 text-slate-300 font-medium">
                        <div class="flex items-center space-x-2"><i class="fas fa-clock text-indigo-400"></i> <span>{{
                                course.duration }}</span></div>
                        <div class="flex items-center space-x-2"><i class="fas fa-signal text-emerald-400"></i> <span>{{
                                course.level }} Level</span></div>
                        <div class="flex items-center space-x-2"><i class="fas fa-users text-amber-400"></i> <span>1.2k
                                Students</span></div>
                    </div>
                </div>
                <div class="hidden md:block">
                    <div
                        class="w-24 h-24 bg-indigo-600 rounded-3xl flex items-center justify-center text-white text-5xl shadow-lg ring-4 ring-indigo-500/30">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-12">
            <!-- Main Content -->
            <div class="lg:col-span-8 space-y-12">
                <!-- Course Modules -->
                <div class="bg-white rounded-[2.5rem] p-10 shadow-xl border border-slate-100">
                    <h2 class="text-3xl font-extrabold text-slate-900 mb-8 tracking-tight">Curriculum Structure</h2>
                    <div class="space-y-4">
                        {% for module in course.modules %}
                        <div id="module-{{ loop.index }}"
                            class="group border-2 border-slate-50 rounded-2xl p-6 hover:border-indigo-100 hover:bg-indigo-50/30 transition-all duration-300">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-6">
                                    <div id="status-{{ loop.index }}"
                                        class="w-12 h-12 bg-white rounded-xl shadow-sm border border-slate-100 flex items-center justify-center font-extrabold text-indigo-600 group-hover:scale-110 transition-transform">
                                        {{ loop.index }}
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex items-center space-x-3">
                                            <h3
                                                class="font-bold text-slate-800 text-lg group-hover:text-indigo-600 transition-colors">
                                                {{ module.title }}</h3>
                                            <span id="check-{{ loop.index }}" class="hidden text-emerald-500"><i
                                                    class="fas fa-check-circle"></i></span>
                                        </div>
                                        <div class="flex items-center space-x-4 mt-2">
                                            <p class="text-slate-500 text-sm font-medium">{{ module.duration }} â€¢ 1
                                                Video</p>
                                            <button data-index="{{ loop.index }}" onclick="handleComplete(this)"
                                                class="text-xs font-bold text-indigo-500 hover:text-indigo-700 uppercase tracking-wider">Mark
                                                Complete</button>
                                            {% if module.external_url %}
                                            <a href="{{ module.external_url }}" target="_blank"
                                                class="text-xs font-bold text-slate-400 hover:text-indigo-500 uppercase tracking-wider flex items-center">
                                                <span>View Tutorial</span>
                                                <i class="fas fa-external-link-alt ml-1 text-[10px]"></i>
                                            </a>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <button data-video-id="{{ module.video_id }}" data-title="{{ module.title }}"
                                        data-index="{{ loop.index }}" onclick="handlePlay(this)"
                                        class="w-10 h-10 bg-slate-900 text-white rounded-full flex items-center justify-center hover:bg-indigo-600 transition shadow-lg opacity-0 group-hover:opacity-100">
                                        <i class="fas fa-play text-xs"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- AI Assistant Interactivity -->
                <div class="bg-indigo-600 rounded-[2.5rem] p-10 text-white shadow-xl relative overflow-hidden group">
                    <div class="relative z-10">
                        <h2 class="text-3xl font-extrabold mb-6">Expert Course AI Assistant</h2>
                        <form id="courseAssistantForm" class="space-y-6">
                            <div class="relative">
                                <textarea
                                    class="w-full bg-white/10 border-2 border-white/20 rounded-[1.5rem] p-6 text-white placeholder-white/50 focus:bg-white/20 focus:border-white/40 focus:ring-0 transition-all outline-none text-lg min-h-[150px]"
                                    placeholder="e.g., Explain the core principles of Module 2 in simple terms..."></textarea>
                                <div
                                    class="absolute bottom-4 right-4 text-white/30 text-xs font-bold uppercase tracking-widest">
                                    Powered by Groq Llama 3</div>
                            </div>
                            <button type="submit"
                                class="bg-white text-indigo-600 px-10 py-4 rounded-xl font-extrabold text-lg hover:bg-slate-50 transition-colors shadow-lg flex items-center space-x-3">
                                <i class="fas fa-robot"></i>
                                <span>Get Instant Answer</span>
                            </button>
                        </form>
                        <div id="aiResponse"
                            class="hidden mt-8 p-8 bg-white/10 rounded-2xl border border-white/20 backdrop-blur-md animate-fade-in-up">
                            <!-- AI response will appear here -->
                        </div>
                    </div>
                    <i
                        class="fas fa-brain absolute -bottom-20 -right-20 text-[20rem] opacity-5 group-hover:opacity-10 transition-opacity"></i>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="lg:col-span-4 space-y-8">
                <!-- Learning Status -->
                <div class="bg-white rounded-[2.5rem] p-8 shadow-xl border border-slate-100 text-center">
                    <h3 class="text-xl font-bold text-slate-900 mb-8">Learning Progress</h3>
                    <div class="relative inline-flex items-center justify-center mb-8">
                        <svg class="w-40 h-40 transform -rotate-90">
                            <circle cx="80" cy="80" r="70" stroke="currentColor" stroke-width="12" fill="transparent"
                                class="text-slate-100" />
                            <circle cx="80" cy="80" r="70" stroke="currentColor" stroke-width="12" fill="transparent"
                                stroke-dasharray="440" stroke-dashoffset="440"
                                class="text-indigo-600 transition-all duration-1000 ease-in-out" id="progressCircle" />
                        </svg>
                        <div class="absolute text-center">
                            <span class="text-3xl font-extrabold text-slate-900" id="progressText">0%</span>
                            <p class="text-xs font-bold text-slate-400 uppercase">Complete</p>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <button onclick="enrollAndLearn()"
                            class="w-full btn-primary text-white py-5 rounded-2xl font-extrabold text-lg shadow-lg">
                            <i class="fas fa-rocket mr-2"></i>Start Learning Now
                        </button>
                    </div>
                    <p class="mt-4 text-xs font-bold text-slate-400 uppercase tracking-widest">3,456 students already
                        enrolled</p>
                </div>

                <!-- Resources List -->
                <div class="bg-white rounded-[2.5rem] p-8 shadow-xl border border-slate-100">
                    <h3 class="text-lg font-bold text-slate-900 mb-6">Expert Resources</h3>
                    <ul class="space-y-4">
                        <li
                            class="p-4 bg-slate-50 rounded-2xl flex items-center space-x-4 hover:bg-indigo-50 transition-colors cursor-pointer group">
                            <div
                                class="w-10 h-10 bg-white rounded-xl flex items-center justify-center text-indigo-600 shadow-sm border border-slate-100 group-hover:scale-110 transition-transform">
                                <i class="fas fa-file-pdf"></i>
                            </div>
                            <span class="font-bold text-slate-700">Detailed Syllabus</span>
                        </li>
                        <li
                            class="p-4 bg-slate-50 rounded-2xl flex items-center space-x-4 hover:bg-indigo-50 transition-colors cursor-pointer group">
                            <div
                                class="w-10 h-10 bg-white rounded-xl flex items-center justify-center text-indigo-600 shadow-sm border border-slate-100 group-hover:scale-110 transition-transform">
                                <i class="fas fa-code"></i>
                            </div>
                            <span class="font-bold text-slate-700">Source Examples</span>
                        </li>
                        <li
                            class="p-4 bg-slate-50 rounded-2xl flex items-center space-x-4 hover:bg-indigo-50 transition-colors cursor-pointer group">
                            <div
                                class="w-10 h-10 bg-white rounded-xl flex items-center justify-center text-indigo-600 shadow-sm border border-slate-100 group-hover:scale-110 transition-transform">
                                <i class="fas fa-globe"></i>
                            </div>
                            <span class="font-bold text-slate-700">Global Community</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Video Modal -->
<div id="videoModal"
    class="fixed inset-0 z-[100] hidden items-center justify-center p-4 bg-slate-900/90 backdrop-blur-sm">
    <div class="bg-white rounded-[2rem] w-full max-w-5xl overflow-hidden shadow-2xl animate-fade-in-up">
        <div class="p-6 border-b border-slate-100 flex items-center justify-between bg-slate-50">
            <h3 id="modalTitle" class="text-xl font-bold text-slate-900">Module Video</h3>
            <button onclick="closeVideo()" class="text-slate-400 hover:text-slate-600 transition text-2xl">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="aspect-video bg-black relative">
            <iframe id="videoIframe" class="w-full h-full" frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen></iframe>
        </div>
        <div class="p-8 flex items-center justify-between">
            <div class="flex items-center space-x-4 text-slate-500 font-medium italic">
                <i class="fas fa-info-circle text-indigo-500"></i>
                <span>Complete the video to advance your progress.</span>
            </div>
            <button id="modalCompleteBtn"
                class="bg-emerald-500 text-white px-8 py-3 rounded-xl font-bold hover:bg-emerald-600 transition shadow-lg flex items-center space-x-2">
                <i class="fas fa-check"></i>
                <span>Mark as Complete</span>
            </button>
        </div>
    </div>
</div>

<script>
    document.getElementById('courseAssistantForm').addEventListener('submit', async function (e) {
        e.preventDefault();
        const textarea = this.querySelector('textarea');
        const question = textarea.value;
        const responseDiv = document.getElementById('aiResponse');
        const button = this.querySelector('button');

        if (!question.trim()) {
            textarea.classList.add('border-red-400');
            setTimeout(() => textarea.classList.remove('border-red-400'), 2000);
            return;
        }

        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';

        responseDiv.innerHTML = '<div class="flex items-center space-x-4"><div class="animate-bounce w-3 h-3 bg-white rounded-full"></div><div class="animate-bounce w-3 h-3 bg-white rounded-full delay-100"></div><div class="animate-bounce w-3 h-3 bg-white rounded-full delay-200"></div><span class="font-bold ml-4">AI Expert is formulating a response...</span></div>';
        responseDiv.classList.remove('hidden');

        try {
            const response = await fetch('/api/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    topic: question + " (in context of " + "{{ course.title }}" + " course)"
                })
            });

            const data = await response.json();
            responseDiv.innerHTML = `
                <div class="prose prose-invert max-w-none">
                    <div class="flex items-center space-x-3 mb-6">
                        <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center"><i class="fas fa-robot text-sm"></i></div>
                        <h4 class="font-bold text-sm uppercase tracking-widest text-white/70">Expert Response</h4>
                    </div>
                    ${data.professor || data.advisor || 'No response generated'}
                </div>
            `;
        } catch (error) {
            responseDiv.innerHTML = '<div class="text-white bg-red-500/20 p-4 rounded-xl border border-red-500/30">Failed to connect with AI service. Please try again.</div>';
        } finally {
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-robot mr-2"></i>Get Instant Answer';
        }
    });

    function enrollAndLearn() {
        // Redirect to learn page with the course title as topic
        const topic = "{{ course.title }}";
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = "{{ url_for('learn') }}";

        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'topic';
        input.value = topic;

        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
    }

    let completedModules = new Set();
    const totalModules = parseInt("{{ course.modules|length }}");

    function handleComplete(btn) {
        const index = parseInt(btn.getAttribute('data-index'));
        markComplete(index);
    }

    function handlePlay(btn) {
        const videoId = btn.getAttribute('data-video-id');
        const title = btn.getAttribute('data-title');
        const index = parseInt(btn.getAttribute('data-index'));
        playModule(videoId, title, index);
    }

    function playModule(videoId, title, index) {
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('videoIframe').src = `https://www.youtube.com/embed/${videoId}?autoplay=1`;
        document.getElementById('videoModal').classList.remove('hidden');
        document.getElementById('videoModal').classList.add('flex');

        document.getElementById('modalCompleteBtn').onclick = () => {
            markComplete(index);
            closeVideo();
        };
    }

    function closeVideo() {
        document.getElementById('videoModal').classList.add('hidden');
        document.getElementById('videoModal').classList.remove('flex');
        document.getElementById('videoIframe').src = '';
    }

    function markComplete(index) {
        completedModules.add(index);

        // Update UI
        const statusEl = document.getElementById(`status-${index}`);
        const checkEl = document.getElementById(`check-${index}`);
        const moduleEl = document.getElementById(`module-${index}`);

        statusEl.classList.remove('text-indigo-600', 'bg-white');
        statusEl.classList.add('bg-emerald-500', 'text-white', 'border-emerald-500');
        checkEl.classList.remove('hidden');
        // moduleEl.classList.add('bg-emerald-50/20', 'border-emerald-100'); // This line was commented out in the original, but if moduleEl exists, it should be applied. Assuming it's not there.

        updateProgress();
    }

    function updateProgress() {
        const percentage = Math.round((completedModules.size / totalModules) * 100);
        const circle = document.getElementById('progressCircle');
        const text = document.getElementById('progressText');

        if (text) text.innerText = `${percentage}%`;

        if (circle) {
            const offset = 440 - (440 * percentage) / 100;
            circle.style.strokeDashoffset = offset;
        }
    }

    // Initialize
    setTimeout(() => {
        updateProgress();
    }, 500);
</script>
{% endblock %}